<style>
    .custom-table-container {
        
        margin: 0 auto; /* Center the container */
        border: 1px solid #ddd; /* Add a light gray border */
        border-radius: 8px; /* Add rounded corners */
        padding: 20px; /* Add some padding inside the container */
        background-color: #f9f9f9; /* Optional: Add a light background color */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Add a subtle shadow */
    }

    .btn-auto-width {
        width: auto; /* Ensure the button width fits its text */
    }
</style>
<style>
    /* Increase the width of the modal */
    .modal-xl {
        max-width: 90%; /* Set the modal width to 90% of the viewport */
    }
    
    /* Make the modal resizable */
    .resizable-modal {
        resize: both; /* Allow horizontal and vertical resizing */
        overflow: auto; /* Add scrollbars if content overflows */
        min-width: 600px; /* Set a minimum width */
        min-height: 400px; /* Set a minimum height */
        max-height: 90vh; /* Prevent the modal from exceeding the viewport height */
        max-width: 95vw; /* Prevent the modal from exceeding the viewport width */
        border: 1px solid #ddd; /* Optional: Add a border for better visibility */
        border-radius: 8px; /* Optional: Add rounded corners */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Add a subtle shadow */
    }
    </style>
<style>
    /* Style for the fournisseur select box */
select#fournisseur_id {
    background-color: white; /* Set background color to white */
    color: black; /* Set font color to black */
    border: 1px solid #ccc; /* Add a light gray border */
    border-radius: 4px; /* Add rounded corners */
    padding: 5px; /* Add padding for better spacing */
    font-size: 14px; /* Adjust font size */
    transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Smooth hover and focus effects */
}

/* Optional: Change the hover effect */
select#fournisseur_id:hover {
    border-color: #888; /* Darker border on hover */
}

/* Optional: Change the focus effect */
select#fournisseur_id:focus {
    outline: none; /* Remove the default outline */
    border-color: #2196f3; /* Blue border on focus */
    box-shadow: 0 0 5px rgba(33, 150, 243, 0.5); /* Add a subtle shadow */
}

/* Style for the placeholder text */
select#fournisseur_id option[value=""][disabled] {
    color: #aaa; /* Light gray color for placeholder text */
}

select#fournisseur_id option[value=""][disabled] {
    color: #aaa; /* Light gray color for placeholder text */
}

select#fournisseur_id {
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}
</style>

<div class="container mt-4 custom-table-container">
    <div >
        <h5>Gestion des Soumissions</h5>
        <button class="btn btn-primary mb-3 btn-auto-width" data-bs-toggle="modal" data-bs-target="#addSoumissionModal">Ajouter une Soumission</button>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Fournisseur</th>
                    <th>Montant Total</th>
                   
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="soumissionsTableBody">
                <!-- Rows will be dynamically generated -->
            </tbody>
        </table>
    </div>
</div>


<!-- Add Soumission Modal -->
<div class="modal fade" id="addSoumissionModal" tabindex="-1" aria-labelledby="addSoumissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addSoumissionForm" action="{{ url_for('consultations.add_soumission', id=consultation.id) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSoumissionModalLabel">Ajouter une Soumission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="mb-3">
                        <label for="fournisseur_id" class="form-label">Fournisseur</label>
                        <select id="fournisseur_id" name="fournisseur_id" class="form-select" required>
                            <option value="" disabled selected>Choisir un fournisseur</option>
                            {% for fournisseur in fournisseurs %}
                                <option value="{{ fournisseur.id }}">{{ fournisseur.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="montant_total" class="form-label">Montant Total</label>
                        <input type="number" id="montant_total" name="montant_total" class="form-control" required>
                    </div>
                    <!-- New Field for Soumission Document -->
                    <div class="mb-3">
                        <label for="soumission_document" class="form-label">Document de Soumission</label>
                        <input type="file" id="soumission_document" name="soumission_document" class="form-control" accept=".pdf,.doc,.docx" required>
                        <small class="form-text text-muted">Formats acceptés : PDF, DOC, DOCX</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteSoumissionModal" tabindex="-1" aria-labelledby="deleteSoumissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSoumissionModalLabel">Confirmer la Suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer cette soumission ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Soumission Modal -->
<div class="modal fade" id="editSoumissionModal" tabindex="-1" aria-labelledby="editSoumissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editSoumissionForm" action="" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSoumissionModalLabel">Modifier une Soumission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_soumission_id" name="soumission_id">

                    <div class="mb-3">
                        <label for="edit_fournisseur_id" class="form-label">Fournisseur</label>
                        <select id="edit_fournisseur_id" name="fournisseur_id" class="form-select" required>
                            <option value="" disabled>Choisir un fournisseur</option>
                            {% for fournisseur in fournisseurs %}
                                <option value="{{ fournisseur.id }}">{{ fournisseur.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>

                   

                 

                    <div class="mb-3">
                        <label for="edit_soumission_document" class="form-label">Document de Soumission</label>
                        <input type="file" id="edit_soumission_document" name="soumission_document" class="form-control" accept=".pdf,.doc,.docx">
                        <small class="form-text text-muted">Laissez vide si vous ne souhaitez pas modifier le document.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Offre Technique Modal -->
<div class="modal fade" id="offreTechniqueModal" tabindex="-1" aria-labelledby="offreTechniqueModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="offreTechniqueModalLabel">Offres Techniques</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Produit</th>
                            <th>Spécifications</th>
                            
                        </tr>
                    </thead>
                    <tbody id="offreTechniqueTableBody">
                        <!-- Rows will be dynamically populated -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
<!-- Offre Financière Modal -->
<div class="modal fade" id="offreFinanciereModal" tabindex="-1" aria-labelledby="offreFinanciereModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl resizable-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="offreFinanciereModalLabel">Offres Financières</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Produit</th>
                            <th>Qte</th>
                            <th>PU</th>
                            <th>Unite Monet.</th>
                            <th>Taux</th>
                            <th>PU MRU</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="offreFinanciereTableBody">
                        <!-- Rows will be dynamically populated -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>




<script>
    document.addEventListener('DOMContentLoaded', function () {
        const soumissionsTableBody = document.getElementById('soumissionsTableBody');
    
        // Fetch and display soumissions
        function fetchSoumissions() {
            fetch(`/consultations/{{ consultation.id }}/soumissions`)
                .then(response => response.json())
                .then(data => {
                    soumissionsTableBody.innerHTML = '';
                    data.forEach((soumission, index) => {
                        soumissionsTableBody.innerHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${soumission.fournisseur}</td>
                                <td>${soumission.montant_total}</td>
                                
                                <td>
                                    <button class="btn btn-sm btn-primary" data-id="${soumission.id}"  data-bs-toggle="modal" data-bs-target="#offreTechniqueModal">Offres Techniques</button>
                                    <button class="btn btn-sm btn-primary"  data-id="${soumission.id}" data-bs-toggle="modal" data-bs-target="#offreFinanciereModal">Offres Financières</button>
                                    <button class="btn btn-sm btn-warning edit-soumission-btn" 
                                    data-id="${soumission.id}" 
                                    data-fournisseur="${soumission.fournisseur_id}" 
                                    data-montant="${soumission.montant_total}" 
                                    data-ordre="${soumission.ordre_classement}">
                                    Modifier
                                </button>
                               <button class="btn btn-sm btn-danger delete-soumission-btn" data-id="${soumission.id}" data-bs-toggle="modal" data-bs-target="#deleteSoumissionModal">Supprimer</button>
                            </tr>
                        `;
                    });
                });
        }
    
        fetchSoumissions();
    });
    </script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const soumissionsTableBody = document.getElementById('soumissionsTableBody');
        const editSoumissionForm = document.getElementById('editSoumissionForm');
        const editSoumissionModal = new bootstrap.Modal(document.getElementById('editSoumissionModal'));

        // Fetch and display soumissions
        function fetchSoumissions() {
            fetch(`/consultations/{{ consultation.id }}/soumissions`)
                .then(response => response.json())
                .then(data => {
                    soumissionsTableBody.innerHTML = '';
                    console.log(data); // Debug the JSON response
                    data.forEach((soumission, index) => {
                        soumissionsTableBody.innerHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${soumission.fournisseur}</td>
                                <td>${soumission.montant_total}</td>
                                <td>
                                   <button class="btn btn-sm btn-primary" data-id="${soumission.id}" data-bs-toggle="modal" data-bs-target="#offreTechniqueModal">Offres Techniques </button>
                                   <button class="btn btn-sm btn-primary" data-id="${soumission.id}" data-bs-toggle="modal" data-bs-target="#offreFinanciereModal">Offres Financieres </button> 
                                    <button class="btn btn-sm btn-warning edit-soumission-btn" data-id="${soumission.id}" data-fournisseur="${soumission.fournisseur_id}" data-montant="${soumission.montant_total}" >Modifier</button>
                                    <button class="btn btn-sm btn-danger delete-soumission-btn" data-id="${soumission.id}" data-bs-toggle="modal" data-bs-target="#deleteSoumissionModal">Supprimer</button>
                                </td>
                            </tr>
                        `;
                    });

                    // Add event listeners for edit buttons
                    document.querySelectorAll('.edit-soumission-btn').forEach(button => {
                        button.addEventListener('click', function () {
                            event.preventDefault(); // Prevent default form submission
                            const soumissionId = this.getAttribute('data-id');
                            const fournisseurId = this.getAttribute('data-fournisseur');
                            const montantTotal = this.getAttribute('data-montant');
                            console.log(`Form action set to: ${editSoumissionForm.action}`);

                            // Populate the form fields
                            document.getElementById('edit_soumission_id').value = soumissionId;
                            document.getElementById('edit_fournisseur_id').value = fournisseurId;
                            //document.getElementById('edit_montant_total').value = montantTotal;
                           
                             // Dynamically set the form action
                             document.getElementById('editSoumissionForm').action = `soumissions/${soumissionId}/edit`;

                            // Show the modal
                            editSoumissionModal.show();
                        });
                    });



                });
        }

        fetchSoumissions();
    });


</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    let soumissionIdToDelete = null;

    // Use event delegation to handle clicks on dynamically generated delete buttons
    const soumissionsTableBody = document.getElementById('soumissionsTableBody');
    soumissionsTableBody.addEventListener('click', function (event) {
        if (event.target && event.target.classList.contains('delete-soumission-btn')) {
            // Get the soumission ID from the button
            soumissionIdToDelete = event.target.getAttribute('data-id');
            console.log('Soumission ID to delete:', soumissionIdToDelete); // Debugging
        }
    });

    // Handle the confirmation button click
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');
    
    if (confirmDeleteButton) {
        confirmDeleteButton.addEventListener('click', function () {
            if (soumissionIdToDelete) {
                console.log('Deleting soumission with ID:', soumissionIdToDelete); // Debugging

                // Send a POST request to delete the soumission
                fetch(`/consultations/soumissions/${soumissionIdToDelete}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Soumission supprimée avec succès.');
                        location.reload(); // Reload the page to update the table
                    } else {
                        alert('Erreur lors de la suppression de la soumission.');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Une erreur est survenue.');
                })
                .finally(() => {
                    // Hide the modal after the request
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteSoumissionModal'));
                    deleteModal.hide();
                });
            } else {
                console.error('No soumission ID to delete.');
            }
        });
    } else {
        console.error('Confirm Delete Button not found.');
    }
});
   </script>

<script>
   
document.addEventListener('DOMContentLoaded', function () {
    const soumissionsTableBody = document.getElementById('soumissionsTableBody');

    // Use event delegation for dynamically generated buttons
    soumissionsTableBody.addEventListener('click', function (event) {
        if (event.target && event.target.getAttribute('data-bs-target') === '#offreFinanciereModal') {
            const soumissionId = event.target.getAttribute('data-id');
            console.log('Soumission ID:', soumissionId);

            // Fetch and populate the modal
            fetch(`/consultations/soumissions/${soumissionId}/offres_financieres`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Unexpected response format: Expected an array.');
                    }

                    const tableBody = document.getElementById('offreFinanciereTableBody');
                    tableBody.innerHTML = ''; // Clear existing rows
                    data.forEach((offre, index) => {
                        tableBody.innerHTML += `
                            <tr data-id="${offre.id}">
                                <td>${index + 1}</td>
                                <td>${offre.produit}</td>
                                <td><input type="number" class="form-control qte-input" value="${offre.qte}" /></td>
                                <td><input type="number" class="form-control pu-input" value="${offre.prix_unitaire}" /></td>
                                <td>
                                    <select class="form-select unite-monetaire-select">
                                        <option value="MRU" ${offre.unite_monetaire === 'MRU' ? 'selected' : ''}>MRU</option>
                                        <option value="$" ${offre.unite_monetaire === '$' ? 'selected' : ''}>$</option>
                                        <option value="Euro" ${offre.unite_monetaire === 'Euro' ? 'selected' : ''}>Euro</option>
                                    </select>
                                </td>
                                <td><input type="number" class="form-control taux-echange-input" value="${offre.taux_echange || 1}" ${offre.unite_monetaire === 'MRU' ? 'disabled' : ''} /></td>
                                <td><input type="number" class="form-control pu-mru-input" value="${offre.prix_unitaire_mru}" readonly /></td>
                                <td><input type="number" class="form-control total-input" value="${offre.total}" readonly /></td>
                                <td>
                                    <button class="btn btn-sm btn-success update-offre-btn">Update</button>
                                </td>
                            </tr>
                        `;
                    });

                    // Add event listeners for the "Update" buttons
                    document.querySelectorAll('.update-offre-btn').forEach(button => {
                        button.addEventListener('click', function () {
                            const row = this.closest('tr');
                            const offreId = row.getAttribute('data-id');
                            const qte = parseFloat(row.querySelector('.qte-input').value);
                            const pu = parseFloat(row.querySelector('.pu-input').value);
                            const uniteMonetaire = row.querySelector('.unite-monetaire-select').value;
                            const tauxEchange = parseFloat(row.querySelector('.taux-echange-input').value) || 1;
                            const puMru = uniteMonetaire === 'MRU' ? pu : pu * tauxEchange;
                            const total = qte * puMru;

                            // Validate taux_echange if not MRU
                            if (uniteMonetaire !== 'MRU' && !tauxEchange) {
                                alert('Taux d\'échange ne peut pas être vide pour les devises non-MRU.');
                                return;
                            }

                            // Send the updated data to the server
                            fetch(`/consultations/soumissions/offres_financieres/${offreId}/update`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    qte: qte,
                                    prix_unitaire: pu,
                                    unite_monetaire: uniteMonetaire,
                                    taux_echange: uniteMonetaire === 'MRU' ? 1 : tauxEchange,
                                    prix_unitaire_mru: puMru,
                                    prix_total: total,
                                }),
                            })
                                .then(response => {
                                    if (response.ok) {
                                        alert('Offre mise à jour avec succès.');
                                    } else {
                                        alert('Erreur lors de la mise à jour de l\'offre.');
                                    }
                                })
                                .catch(error => console.error('Erreur lors de la mise à jour de l\'offre:', error));
                        });
                    });

                    // Automatically update the "Total" and "PU MRU" fields
                    document.querySelectorAll('.qte-input, .pu-input, .taux-echange-input, .unite-monetaire-select').forEach(input => {
                        input.addEventListener('input', function () {
                            const row = this.closest('tr');
                            const qte = parseFloat(row.querySelector('.qte-input').value) || 0;
                            const pu = parseFloat(row.querySelector('.pu-input').value) || 0;
                            const uniteMonetaire = row.querySelector('.unite-monetaire-select').value;
                            const tauxEchangeInput = row.querySelector('.taux-echange-input');
                            const puMruField = row.querySelector('.pu-mru-input');
                            const totalField = row.querySelector('.total-input');

                            // Handle taux_echange logic
                            if (uniteMonetaire === 'MRU') {
                                tauxEchangeInput.value = 1;
                                tauxEchangeInput.disabled = true;
                                puMruField.value = pu.toFixed(2);
                                totalField.value = (qte * pu).toFixed(2);
                            } else {
                                tauxEchangeInput.disabled = false;
                                const tauxEchange = parseFloat(tauxEchangeInput.value) || 0;
                                puMruField.value = (pu * tauxEchange).toFixed(2);
                                totalField.value = (qte * pu * tauxEchange).toFixed(2);
                            }
                        });
                    });
                })
                .catch(error => console.error('Erreur lors du chargement des offres financières:', error));
        }
    });
});
</script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        const soumissionsTableBody = document.getElementById('soumissionsTableBody');
    
        // Use event delegation for dynamically generated buttons
        soumissionsTableBody.addEventListener('click', function (event) {
            if (event.target && event.target.getAttribute('data-bs-target') === '#offreTechniqueModal') {
                const soumissionId = event.target.getAttribute('data-id');
                console.log('Soumission ID:', soumissionId);
    
                // Fetch and populate the modal
                fetch(`/consultations/soumissions/${soumissionId}/offres_techniques`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!Array.isArray(data)) {
                            throw new Error('Unexpected response format: Expected an array.');
                        }
    
                        const tableBody = document.getElementById('offreTechniqueTableBody');
                        tableBody.innerHTML = ''; // Clear existing rows
                        data.forEach((offre, index) => {
                            tableBody.innerHTML += `
                                <tr data-id="${offre.id}">
                                    <td>${index + 1}</td>
                                    <td>${offre.produit}</td>
                                     <td><textarea class="form-control specifications-input">${offre.specifications}</textarea></td>
                                    <td>
                                        <button class="btn btn-sm btn-success update-offre-btn">Update</button>
                                    </td>
                                </tr>
                            `;
                        });
    
                        // Add event listeners for the "Update" buttons
                        document.querySelectorAll('.update-offre-btn').forEach(button => {
                            button.addEventListener('click', function () {
                                const row = this.closest('tr');
                                const offreId = row.getAttribute('data-id');
                                const specifications = row.querySelector('.specifications-input').value;
    
                                // Send the updated data to the server
                                fetch(`/consultations/soumissions/offres_techniques/${offreId}/update`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        specifications: specifications,
                                    }),
                                })
                                    .then(response => {
                                        if (response.ok) {
                                            alert('Offre mise à jour avec succès.');
                                        } else {
                                            alert('Erreur lors de la mise à jour de l\'offre.');
                                        }
                                    })
                                    .catch(error => console.error('Erreur lors de la mise à jour de l\'offre:', error));
                            });
                        });
                    })
                    .catch(error => console.error('Erreur lors du chargement des offres techniques:', error));
            }
        });
    });
</script>